<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>My Teams</h5>
            <p-toast></p-toast>
            <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

            <!-- Actions Buttons -->
            <div class="flex justify-content-end mb-3">
                <button pButton pRipple label="Join Team with Code" icon="pi pi-users" class="p-button-info mr-2" (click)="openJoinDialog()"></button>
<button pButton pRipple label="Create Team" icon="pi pi-plus" class="p-button-success" (click)="openCreateDialog()"></button>
<!-- Admin-only bulk actions can be added here if needed -->
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="isLoading" class="flex justify-content-center">
                <p-progressSpinner></p-progressSpinner>
            </div>

            <!-- My Teams Section -->
            <div *ngIf="!isLoading && userTeams.length > 0" class="mb-5">
                <h6>Teams I'm a Member Of</h6>
                <div class="grid">
                    <div *ngFor="let team of userTeams" class="col-12 md:col-6 lg:col-4">
                        <p-card [header]="team.teamName" styleClass="team-card">
                            <ng-template pTemplate="header">
                                <div class="team-card-header">
                                    <span class="team-status" [ngClass]="{'public': team.isPublic, 'private': !team.isPublic}">
                                        {{team.isPublic ? 'Public' : 'Private'}}
                                    </span>
                                    <span class="team-status" [ngClass]="{'full': team.isFull, 'available': !team.isFull}">
                                        {{team.isFull ? 'Full' : 'Available'}}
                                    </span>
                                </div>
                            </ng-template>

                            <div class="team-members mb-3">
                                <h6>Team Members</h6>
                                <p-avatarGroup styleClass="mb-3">
                                    <p-avatar *ngFor="let member of team.teamMembers?.slice(0, 5)" 
                                        [label]="getUserAvatarLabel(member)" 
                                        shape="circle" 
                                        [style]="{'background-color': member.role === 'LEADER' ? '#FFD700' : '#2196F3'}"
                                        pTooltip="{{getUserDisplayName(member)}} ({{member.role}})"
                                        tooltipPosition="top">
                                    </p-avatar>
                                    <p-avatar *ngIf="team.teamMembers && team.teamMembers.length > 5" 
                                        label="+{{team.teamMembers.length - 5}}" 
                                        shape="circle" 
                                        [style]="{'background-color': '#9C27B0'}">
                                    </p-avatar>
                                </p-avatarGroup>
                            </div>

                            <div class="team-actions">
  <button *ngIf="isAdmin()" pButton pRipple label="Update" icon="pi pi-pencil" class="p-button-warning p-button-outlined mr-2" (click)="openEditDialog(team)"></button>
  <button pButton pRipple label="View Team" icon="pi pi-eye" class="p-button-outlined p-button-info mr-2" (click)="viewTeam(team)"></button>
  <button pButton pRipple label="Chat" icon="pi pi-comments" class="p-button-outlined" [routerLink]="['/teams', team.id, 'chat']"></button>
  <!-- Admin-only Discussion Controls -->
  <button *ngIf="isAdmin()" pButton pRipple label="Manage Discussions" icon="pi pi-comments" class="p-button-help p-button-outlined ml-2" (click)="manageDiscussions(team)"></button>
</div>
                        </p-card>
                    </div>
                </div>
            </div>

            <!-- No Teams Message -->
            <div *ngIf="!isLoading && userTeams.length === 0" class="mb-5">
                <p>You are not a member of any team yet. Join an existing team or create a new one.</p>
            </div>

            <!-- Public Teams Section -->
            <div *ngIf="!isLoading && publicTeams.length > 0" class="mb-3">
                <h6>Available Public Teams</h6>
                <div class="grid">
                    <div *ngFor="let team of publicTeams" class="col-12 md:col-6 lg:col-4">
                        <p-card [header]="team.teamName" styleClass="team-card">
                            <ng-template pTemplate="header">
                                <div class="team-card-header">
                                    <span class="team-status public">Public</span>
                                    <span class="team-status" [ngClass]="{'full': team.isFull, 'available': !team.isFull}">
                                        {{team.isFull ? 'Full' : 'Available'}}
                                    </span>
                                </div>
                            </ng-template>

                            <div class="team-members mb-3">
                                <h6>Team Members</h6>
                                <p-avatarGroup styleClass="mb-3">
                                    <p-avatar *ngFor="let member of team.teamMembers?.slice(0, 5)" 
                                        [label]="getUserAvatarLabel(member)" 
                                        shape="circle" 
                                        [style]="{'background-color': member.role === 'LEADER' ? '#FFD700' : '#2196F3'}"
                                        pTooltip="{{getUserDisplayName(member)}} ({{member.role}})"
                                        tooltipPosition="top">
                                    </p-avatar>
                                    <p-avatar *ngIf="team.teamMembers && team.teamMembers.length > 5" 
                                        label="+{{team.teamMembers.length - 5}}" 
                                        shape="circle" 
                                        [style]="{'background-color': '#9C27B0'}">
                                    </p-avatar>
                                </p-avatarGroup>
                            </div>

                            <div class="team-actions">
    <button pButton pRipple label="Update" icon="pi pi-pencil" class="p-button-warning p-button-outlined mr-2" (click)="openEditDialog(team)"></button>
    <button pButton pRipple label="Join Team" icon="pi pi-sign-in" class="p-button-success mr-2" 
        (click)="joinPublicTeam(team)" [disabled]="team.isFull"></button>
    <button pButton pRipple label="View Details" icon="pi pi-info-circle" class="p-button-outlined p-button-info" 
        (click)="viewTeam(team)"></button>
</div>
                        </p-card>
                    </div>
                </div>
            </div>

            <!-- No Public Teams Message -->
            <div *ngIf="!isLoading && publicTeams.length === 0" class="mb-5">
                <p>There are no public teams available at the moment. You can create a new team or join a team with a code.</p>
            </div>
        </div>
    </div>
</div>

<!-- Join Team Dialog -->
<p-dialog header="Join Team with Code" [(visible)]="displayJoinDialog" [style]="{width: '450px'}" [modal]="true" styleClass="p-fluid">
    <form [formGroup]="joinCodeForm" (ngSubmit)="joinTeamByCode()">
        <div class="field">
            <label for="teamCode">Team Code</label>
            <input type="text" pInputText id="teamCode" formControlName="teamCode" placeholder="Enter team code" />
            <small *ngIf="joinCodeForm.get('teamCode')?.invalid && joinCodeForm.get('teamCode')?.touched" class="p-error">
                Team code is required and must be at least 6 characters.
            </small>
        </div>
        <div class="flex justify-content-end">
            <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="displayJoinDialog = false"></button>
            <button pButton pRipple label="Join" icon="pi pi-check" type="submit" [disabled]="joinCodeForm.invalid"></button>
        </div>
    </form>
</p-dialog>

<!-- Edit Team Dialog -->
<p-dialog header="Edit Team" [(visible)]="displayEditDialog" [style]="{width: '450px'}" [modal]="true" styleClass="p-fluid">
    <form [formGroup]="editTeamForm" (ngSubmit)="updateTeam()">
        <div class="field">
            <label for="editTeamName">Team Name</label>
            <input type="text" pInputText id="editTeamName" formControlName="teamName" placeholder="Enter team name" />
            <small *ngIf="editTeamForm.get('teamName')?.invalid && editTeamForm.get('teamName')?.touched" class="p-error">
                Team name is required and must be at least 3 characters.
            </small>
        </div>
        <div class="field-checkbox">
            <p-toggleButton formControlName="isPublic" [onLabel]="'Public Team'" [offLabel]="'Private Team'" [onIcon]="'pi pi-globe'" [offIcon]="'pi pi-lock'"></p-toggleButton>
            <small class="block mt-2">
                <div>{{ editTeamForm.value.isPublic ? 'Public teams can be joined by anyone without approval.' : 'Private teams require a join code or invitation to join.' }}</div>
            </small>
        </div>
        <div class="flex justify-content-end">
            <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="displayEditDialog = false"></button>
            <button pButton pRipple label="Update" icon="pi pi-check" type="submit" [disabled]="editTeamForm.invalid"></button>
        </div>
    </form>
</p-dialog>

<!-- Create Team Dialog -->
<p-dialog header="Create New Team" [(visible)]="displayCreateDialog" [style]="{width: '500px'}" [modal]="true" styleClass="p-fluid">
    <form [formGroup]="createTeamForm" (ngSubmit)="createTeam()">
        <div class="field">
            <label for="teamName">Team Name</label>
            <input type="text" pInputText id="teamName" formControlName="teamName" placeholder="Enter team name" />
            <small *ngIf="createTeamForm.get('teamName')?.invalid && createTeamForm.get('teamName')?.touched" class="p-error">
                Team name is required and must be at least 3 characters.
            </small>
        </div>
        <div class="field">
            <label for="hackathonId">Hackathon</label>
            <p-dropdown id="hackathonId" [options]="hackathons" formControlName="hackathonId" optionLabel="name" optionValue="id" placeholder="Select a hackathon"></p-dropdown>
            <small *ngIf="createTeamForm.get('hackathonId')?.invalid && createTeamForm.get('hackathonId')?.touched" class="p-error">
                Please select a hackathon.
            </small>
        </div>
        <div class="field-checkbox">
            <p-toggleButton formControlName="isPublic" [onLabel]="'Public Team'" [offLabel]="'Private Team'" [onIcon]="'pi pi-globe'" [offIcon]="'pi pi-lock'"></p-toggleButton>
            <small class="block mt-2">
                <div>{{ createTeamForm.value.isPublic ? 'Public teams can be joined by anyone without approval.' : 'Private teams require a join code or invitation to join.' }}</div>
            </small>
        </div>
        <div class="flex justify-content-end">
            <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="displayCreateDialog = false"></button>
            <button pButton pRipple label="Create" icon="pi pi-check" type="submit" [disabled]="createTeamForm.invalid"></button>
        </div>
    </form>
</p-dialog>
